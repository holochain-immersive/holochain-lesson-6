<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="Description" content="Put your description here." />
    <base href="/" />

    
    <title>Lesson 6</title>
    <script type="module" crossorigin src="/holochain-lesson-6/assets/index-d4112844.js"></script>
    <link rel="stylesheet" href="/holochain-lesson-6/assets/index-d9e0dbf5.css">
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Validation Rules</h1>
        </section>

        <!-- prettier-ignore -->
        <section language="markdown" animate="by-line with-ancestry">
          ### Validation Workflow

          - Validation needs to be deterministic: same result no matter who runs it and when.
          - After an action is committed, it is transformed into different DHT Operations (DHT Ops)
          - Then, those DHT Ops are published to the different neighborhoods in the DHT
          - When those nodes receive that publish, they add it to their validation queue
            - If the validation fails, those nodes produce warrants that get gossiped throughout the network
              - All other nodes can verify that the bad agent is behaving badly
              - They then disconnect from the bad agent
            - If the validation succeeds, the node starts to serve that record to DHT queries (get, get_links, etc.)

          ### Validation callback function context

          - The function `validate` is called in two contexts
            1. The author validates their own recods before publishing them
            2. All prospective hosts of the DHT Op validate  
        </section>

        <!-- prettier-ignore -->
        <section
          language="markdown"
          animate="by-line with-ancestry"
          style="font-size: 15px; width: 120%; margin-left: -5%; line-height: 1.5em;"
        >
          ## DHT Ops
          <table>
            <thead>
              <tr>
                <th>Chain Action</th>
                <th>DhtOp Name</th>
                <th>Targeted hash basis</th>
                <th>Payload</th>
                <th>Metadata</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td rowspan="3">
                  <div class="fragment">create_entry(entry)</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterAgentActivity</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Author's public key</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreRecord</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="fragment">StoreEntry</div>
                </td>
                <td>
                  <div class="fragment">Hash of the entry</div>
                </td>
                <td>
                  <div class="fragment">Record</div>
                </td>
                <td>
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td rowspan="5">
                  <div class="fragment">
                    update_entry(original_action_hash, new_entry)
                  </div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterAgentActivity</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Author's public key</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreRecord</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreEntry</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the entry</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterEntryUpdate</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the original entry</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Old entry is updated to new entry</div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="fragment">RegisterRecordUpdate</div>
                </td>
                <td>
                  <div class="fragment">Hash of the original action</div>
                </td>
                <td>
                  <div class="fragment">New action</div>
                </td>
                <td>
                  <div class="fragment">
                    Old action is updated to new action
                  </div>
                </td>
              </tr>
              <tr>
                <td rowspan="4">
                  <div class="fragment">delete_entry(action_hash)</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterAgentActivity</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Author's public key</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreRecord</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the new action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterEntryDelete</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the deleted entry</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">New Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Old entry deleted by new action</div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="fragment">RegisterRecordDelete</div>
                </td>
                <td>
                  <div class="fragment">Hash of the deleted action</div>
                </td>
                <td>
                  <div class="fragment">New Action</div>
                </td>
                <td>
                  <div class="fragment">Old action deleted by new action</div>
                </td>
              </tr>
              <tr>
                <td rowspan="3">
                  <div class="fragment">create_link(base, target, tag)</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterAgentActivity</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Author's public key</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreRecord</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the new action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterCreateLink</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">"Base" hash</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">
                    Link from the base to the target hash
                  </div>
                </td>
              </tr>
              <tr>
                <td rowspan="3">
                  <div class="fragment">
                    delete_link(create_link_action_hash)
                  </div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">RegisterAgentActivity</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Author's public key</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the action</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">StoreRecord</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Hash of the new action</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">Record</div>
                </td>
                <td style="border-bottom: dotted; border-bottom-color: #808080">
                  <div class="fragment">-</div>
                </td>
              </tr>
              <tr>
                <td style="border-bottom: 1px solid">
                  <div class="fragment">RegisterDeleteLink</div>
                </td>
                <td style="border-bottom: 1px solid">
                  <div class="fragment">
                    Hash of the deleted create link action hash
                  </div>
                </td>
                <td style="border-bottom: 1px solid">
                  <div class="fragment">Action</div>
                </td>
                <td style="border-bottom: 1px solid">
                  <div class="fragment">Deleted link sent to tombstone</div>
                </td>
              </tr>
            </tbody>
          </table>
        </section>
        <!-- prettier-ignore -->
        <section language="markdown" animate="by-line with-ancestry">
          ### System Validation

          - Does not depend on your application code
          - Holochain enforces some system level validations across all apps
            - Actions
              - Source chains can't be forked
              - All actions must be signed by their author
              - Timestamp and sequence number for the actions must be incremental
              - If the action is accompanied by an entry, the entry hash in the action is correct
            - Entries
              - The entry byte array can be deserialized to the appropriate struct
        </section>

        <section>
          <!-- prettier-ignore -->
          <fragment language="markdown" animate="by-line with-ancestry">
            ### App Validation

            - Validation rules for a given entry or link type must go in the same zome as the type definition
            - Private entries are only validated by its author, so you can't trust the private entries to be valid
            - Callback: `validate(dht_op: Op)`
          </fragment>

          <fragment>
            <pre>
              <code class="rust" data-noescape data-trim
              animate="by-line balanced with-ancestry separate-comments trailing-comments-in-popover strike-on-error-in-comment"
              >
#[hdk_extern]
pub fn validate(op: Op) -> ExternResult&lt;ValidateCallbackResult&gt; {
  match op.flattened::&lt;EntryTypes, LinkTypes&gt;()? {
    FlatOp::StoreEntry(store_entry) => match store_entry {
      OpEntry::CreateEntry { app_entry, action } => match app_entry {
        EntryTypes::Post(post) => Ok(ValidateCallbackResult::Valid), // All posts are valid
      },
      _ => Ok(ValidateCallbackResult::Valid),
    },
    FlatOp::RegisterUpdate(update_entry) |
    FlatOp::RegisterDelete(delete_entry) |
    FlatOp::RegisterCreateLink { .. } | 
    FlatOp::RegisterDeleteLink { .. } |
    FlatOp::StoreRecord(store_record) |
    FlatOp::RegisterAgentActivity(agent_activity) => Ok(ValidateCallbackResult::Valid)
  }
}
              </code>
            </pre>
          </fragment>

          <!-- prettier-ignore -->
          <fragment language="markdown" animate="by-line with-ancestry">
            - Three results possible:
              1. Valid
              2. Invalid: it specifies the reason why it failed
              3. Unresolved dependencies: Not enough data to complete the validation
          </fragment>
        </section>

        <!-- prettier-ignore -->
        <section language="markdown" animate="by-line with-ancestry">
          ### Validation challenges

          - Non-deterministic queries can't be considered during validation
            - `get` and `get_details` are forbidden 
              - They attempt to return a current list of updates and deletes
            - `get_links` is forbidden
            - `get_agent_activity` is forbidden unless bounded by action hashes
          - Deterministic alternatives:
            - `must_get_entry`
              - Only returns the entry, not its action
              - Never returns `None`, rather the validation has unresolved dependencies
            - `must_get_action`
              - Only returns the action
              - Never returns `None`, rather the validation has unresolved dependencies
            - `must_get_valid_record`
              - Returns the record
              - Never returns `None`, rather the validation has unresolved dependencies
            - `must_get_agent_activity`
              - Returns the source chain actions stored in the DHT for a given agent
              - Needs the chain_top action ID for the given agent
              - Never returns `None`, rather the validation has unresolved dependencies
        </section>

        <section>
          <!-- prettier-ignore -->
          <fragment language="markdown" animate="by-line with-ancestry">
          ### Genesis Self-Check

          - Callback executed when the cell is instantiated
          - If it fails, the app for that cell will fail to install
        </fragment>
          <fragment>
            <pre>
            <code class="rust" data-noescape data-trim
            animate="by-line balanced with-ancestry separate-comments trailing-comments-in-popover strike-on-error-in-comment"
            >
#[hdk_extern]
pub fn genesis_self_check(data: GenesisSelfCheckData) -> ExternResult&lt;ValidateCallbackResult&gt; {
    // Check data.agent_key, data.membrane_proof
}
            </code>
          </pre>
          </fragment>
        </section>

        <section>
          <h1>That's it!</h1>
        </section>
      </div>
    </div>

    
  </body>
</html>
